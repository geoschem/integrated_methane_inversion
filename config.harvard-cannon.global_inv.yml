## IMI configuration file, updated with Melissa's config 8/4/23
## Documentation @ https://imi.readthedocs.io/en/latest/getting-started/imi-config-file.html

## General
RunName: "clustering"
isAWS: false
UseSlurm: true
SafeMode: false
S3Upload: false

## Period of interest
StartDate: 20220701
EndDate: 20220731
SpinupMonths: 1

## Use blended TROPOMI+GOSAT data (true)? Or use operational TROPOMI data (false)?
BlendedTROPOMI: true

## Use nested grid simulation?
NestedGrid: false

NestedRegion: ""

## Is this a regional inversion? Set to false for global inversion
isRegional: false

## Select two character region ID (for using pre-cropped meteorological fields)
##   Current options are listed below with ([lat],[lon]) bounds:
##     "AF" : Africa ([-37,40], [-20,53])
##     "AS" : Asia ([-11,55],[60,150]) 
##     "EU" : Europe ([33,61],[-30,70])
##     "ME" : Middle East ([12,44], [-20,70])
##     "NA" : North America ([10,70],[-140,-40])
##     "OC" : Oceania ([-50,5], [110,180])
##     "RU" : Russia ([41,83], [19,180])
##     "SA" : South America ([-59,16], [-88,-31])
##     ""   : Use for global global simulation or custom regions
##   For example, if the region of interest is in Europe ([33,61],[-30,70]), select "EU".
RegionID: ""

## Region of interest
##   These lat/lon bounds are only used if CreateAutomaticRectilinearStateVectorFile: true
##   Otherwise lat/lon bounds are determined from StateVectorFile
LonMin: -180
LonMax: 177.5 # prev 180
LatMin: -90
LatMax: 90

## Kalman filter options
KalmanMode: false
UpdateFreqDays: 7
NudgeFactor: 0.1

## State vector
CreateAutomaticRectilinearStateVectorFile: true
nBufferClusters: 0
BufferDeg: 0
LandThreshold: 0.25
OffshoreEmisThreshold: 0

## Clustering Options
ReducedDimensionStateVector: true
DynamicKFClustering: false
ClusteringMethod: "kmeans"
NumberOfElements: 1000
ForcedNativeResolutionElements: 
  - [31.5, -104]
  
## Custom state vector
StateVectorFile: "/path/to/StateVector.nc" # put Global Native State Vector here?
# "/n/holyscratch01/jacob_lab/$USER/Global_IMI/StateVector.nc"
ShapeFile: "None"

## Inversion
PriorError: 0.5
ObsError: 15
Gamma: 0.3
PrecomputedJacobian: false

## Grid
##   Options are 0.25x0.3125, 2x2.5, or 4x5
Res: "2x2.5"

## Meteorology
##   Options are geosfp or merra2
Met: "geosfp"

## Setup modules
##   Turn on/off different steps in setting up the inversion 
SetupTemplateRundir: false
SetupSpinupRun: false
SetupJacobianRuns: false
SetupInversion: false
SetupPosteriorRun: false

## Run modules
##   Turn on/off different steps in performing the inversion
RunSetup: true
DoSpinup: false
DoJacobian: false
DoInversion: false
DoPosterior: false

## IMI preview
DoPreview: false
DOFSThreshold: 0

##====================================================================
##
## Advanced Settings (optional)
##
##====================================================================

## These settings are intended for advanced users who wish to:
##   a. modify additional GEOS-Chem options, or
##   b. run the IMI on a local cluster.
## They can be ignored for any standard cloud application of the IMI.

##--------------------------------------------------------------------
## Additional settings for GEOS-Chem simulations
##--------------------------------------------------------------------

## Jacobian settings
PerturbValue: 1.5

## Apply scale factors from a previous inversion?
UseEmisSF: false
UseOHSF: false

## Save out hourly diagnostics from GEOS-Chem?
## For use in satellite operators via post-processing -- required for TROPOMI
## inversions
HourlyCH4: true

## Turn on planeflight diagnostic in GEOS-Chem?
## For use in comparing GEOS-Chem against planeflight data. The path
## to those data must be specified in input.geos.
PLANEFLIGHT: false

## Turn on old observation operators in GEOS-Chem?
## These will save out text files comparing GEOS-Chem to observations, but have
## to be manually incorporated into the IMI
GOSAT: false
TCCON: false
AIRS: false

## resources to allocate to slurm jobs
SimulationCPUs: 32
SimulationMemory: 300000
JacobianCPUs: 1
JacobianMemory: 7000
RequestedTime: "0-6:00"
SchedulerPartition: "huce_bigmem,seas_compute,huce_intel,shared"

##--------------------------------------------------------------------
## Settings for running on a local cluster
##--------------------------------------------------------------------

## Path for IMI runs and output
OutputPath: "/n/holyscratch01/jacob_lab/$USER"

## Path to GEOS-Chem input data
DataPath: "/n/holyscratch01/external_repos/GEOS-CHEM/gcgrid/gcdata/ExtData"

## Path to TROPOMI Data
DataPathTROPOMI: "/n/holylfs05/LABS/jacob_lab/imi/ch4/blended"
# DataPathTROPOMI: "/n/holylfs05/LABS/jacob_lab/imi/ch4/tropomi" 
# use blended product "/n/holylfs05/LABS/jacob_lab/imi/ch4/blended"

## Environment files
## See envs/README to create the Conda environment specified below
CondaEnv: "imi_env"
GEOSChemEnv: "/n/home12/mhe/cannon-env/envs/gnu12/gcclassic.rocky+gnu12.minimal.env"

## Download initial restart file from AWS S3?
##  NOTE: Must have AWS CLI enabled
RestartDownload: false

## Path to initial GEOS-Chem restart file + prefix
##   ("YYYYMMDD_0000z.nc4" will be appended)
RestartFilePrefix: "/n/holylfs05/LABS/jacob_lab/imi/ch4/tropomi-boundary-conditions/v2023-06/GEOSChem.BoundaryConditions."
RestartFilePreviewPrefix: "/n/holylfs05/LABS/jacob_lab/imi/ch4/tropomi-boundary-conditions/v2023-06/GEOSChem.BoundaryConditions."

## Path to GEOS-Chem boundary condition files (for regional simulations)
## Must put backslash before $ in $YYYY$MM$DD to properly work in sed command
## BCversion will be appended to the end of this path. ${BCpath}/${BCversion}
BCpath: "/n/holylfs05/LABS/jacob_lab/imi/ch4/tropomi-boundary-conditions"
BCversion: "v2023-06"

## Options to download missing GEOS-Chem input data from AWS S3
##  NOTE: Must have AWS CLI enabled
PreviewDryRun: false
SpinupDryrun: false
ProductionDryRun: false
PosteriorDryRun: false
BCdryrun: false
